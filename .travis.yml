sudo: required
services:
- docker
jobs:
  include:
  - stage: build docker images
    script:
    - export TAG=$(if [ "x$TRAVIS_TAG" != "x" ]; then echo "$TRAVIS_TAG"; else git
      rev-parse --short HEAD; fi)
    - travis_wait 40 docker build -t $DOCKER_REPO/base base
    - travis_wait 90 docker build -t $DOCKER_REPO/single-user single-user
    - docker tag $DOCKER_REPO/single-user $DOCKER_REPO/single-user:$TAG
    - docker build -t $DOCKER_REPO/single-user-aginfra single-user-aginfra
    - docker tag $DOCKER_REPO/single-user-aginfra $DOCKER_REPO/single-user-aginfra:$TAG
    - docker build -t $DOCKER_REPO/d4science-storage d4science-storage
    - docker tag $DOCKER_REPO/d4science-storage $DOCKER_REPO/d4science-storage:$TAG
    - docker build -t $DOCKER_REPO/single-user-labss single-user-labss
    - docker tag $DOCKER_REPO/single-user-labss $DOCKER_REPO/single-user-labss:$TAG
    after_success:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_REPO/single-user
    - docker push $DOCKER_REPO/single-user:$TAG
    - docker push $DOCKER_REPO/single-user-aginfra
    - docker push $DOCKER_REPO/single-user-aginfra:$TAG
    - docker push $DOCKER_REPO/d4science-storage
    - docker push $DOCKER_REPO/d4science-storage:$TAG
    - docker push $DOCKER_REPO/single-user-labss
    - docker push $DOCKER_REPO/single-user-labss:$TAG
env:
  global:
  - DOCKER_REPO=eginotebooks
